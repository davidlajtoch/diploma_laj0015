@page "/assignments"

@using DiplomaThesis.Client.Services.Interfaces;
@using DiplomaThesis.Shared.Contracts;
@using Microsoft.AspNetCore.Authorization;

@using System.Text;

@inject NavigationManager Navigation;
@inject AuthenticationStateProvider AuthenticationStateProvider;
@inject IAdministrationService AdministrationService;
@inject IAssignmentService AssignmentService;

@attribute [Authorize]

<PageTitle>Assignments - ReporTiny</PageTitle>

@if (!UserInUserGroup)
{
    <div class="warning_no_user_group animate__animated animate__bounceIn animate__delay-2s">
        <i class="material-icons icon">report</i><br />
        You need to be in a user group to view assignments.
    </div>
}
else
{
    <PageHeader Text="@(UserGroup!.Name + " assignments")" />
    <div class="container animate__animated animate__fadeIn">
        <div class="menu">
            <div class="group_left">
            </div>

            <div class="group_right">
                <div class="input_with_button_default input_with_button">
                    <input @bind="NewAssignmentName" type="text" placeholder="Create new assignment...">
                    <button class="button1" @onclick="CreateAssignment"><i class="material-icons icon">add</i></button>
                </div>
                <input type="text" class="input_search_default" placeholder="Search by name..."
                   @oninput="@((e) => SearchAssignmentByName(e.Value!.ToString()!))">
            </div>
        </div>

        <div class="container_sections">
            @for (int i = 0; i < AssignmentLists.Count(); i++)
            {
                <div class="container_section">
                    @if (AssignmentLists[i] != null || AssignmentLists[i].Count() != 0)
                    {
                        <div class="section_header">@AssignmentCategories.ElementAt(i).Value</div>
                        <div class="section">
                            <div class="list_assignments">
                                @foreach (var assignment in AssignmentLists[i])
                                {
                                    <div class="assignment">
                                        <div class="name">@assignment.Name</div>
                                        <div class="created">@assignment.Created</div>
                                        <div class="description">@assignment.Description</div>
                                        <div class="assignee">
                                            @if (assignment.User != null)
                                            {
                                                @assignment.Description
                                            }
                                            else
                                            {
                                                <span class="text_light">Not assigned</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                    }
                </div>
            }
        </div>
    </div>
}

@code {
    private List<AssignmentContract> AssignmentsUserGroup = new();
    private List<UserContract> UserGroupMembers = new();
    private UserGroupContract? UserGroup = null;
    private Guid UserId = new();

    private List<List<AssignmentContract>> AssignmentLists = new List<List<AssignmentContract>>();

    private Dictionary<int, string> AssignmentCategories = new Dictionary<int, string>
    {
        {0, "To do" },
        {1, "In progress" },
        {2, "Done" },
    };

    private string NewAssignmentName = string.Empty;

    private bool UserInUserGroup = false;
    private bool UserUserGroupLeader = false;

    private async Task UpdateData()
    {
        AssignmentsUserGroup = await AssignmentService.GetUserGroupAssignments(UserGroup!.Id);
        CategorizeAssignments();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await GetSetUserId();
        UserGroup = await AdministrationService.GetUserUserGroup(UserId);

        if (UserGroup!.Id == Guid.Empty)
        {
            return;
        }
        if (UserGroup.LeaderId == UserId)
        {
            UserUserGroupLeader = true;
        }

        AssignmentsUserGroup = await AssignmentService.GetUserGroupAssignments(UserGroup.Id);
        CategorizeAssignments();

        UserInUserGroup = true;
    }

    private async Task GetSetUserId()
    {
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        var userId = user.FindFirst(u => u.Type.Contains("sub"))?.Value;
        UserId = Guid.Parse(userId!);
    }

    private async Task GetSetUserGroupMembers()
    {
        UserGroupMembers = await AdministrationService.GetUserGroupMembers(UserGroup.Id);
        UserGroupMembers = UserGroupMembers!.FindAll(u => u.Id != UserId);
    }

    private void CategorizeAssignments()
    {
        if (AssignmentLists.Count() == AssignmentCategories.Count())
        {
            foreach (KeyValuePair<int, string> assignmentCategory in AssignmentCategories)
            {
                AssignmentLists[assignmentCategory.Key] = AssignmentsUserGroup!.FindAll(a => a.Step == assignmentCategory.Key);
            }
            return;
        }

        foreach (KeyValuePair<int, string> assignmentCategory in AssignmentCategories)
        {
            AssignmentLists.Add(AssignmentsUserGroup!.FindAll(a => a.Step == assignmentCategory.Key));
        }
    }

    private async Task CreateAssignment()
    {
        if (NewAssignmentName == string.Empty || NewAssignmentName == string.Empty)
        {
            return;
        }

        var result = await AssignmentService.CreateAssignment(NewAssignmentName, UserGroup!.Id);

        if (result != null)
        {
            NewAssignmentName = string.Empty;
            AssignmentLists[0].Add(result);
            StateHasChanged();
        }
    }

    private void SearchAssignmentByName(string searchedAssignment)
    {
        if (searchedAssignment == string.Empty || searchedAssignment == null)
        {
            return;
        }
    }
}
