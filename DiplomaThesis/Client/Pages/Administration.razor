@page "/administration"
@using DiplomaThesis.Client.Services.Interfaces
@using DiplomaThesis.Shared.Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

@inject IAdministrationService AdministrationService



    <PageTitle>Administration</PageTitle>
    <PageHeader Text="Administration" />

    @if (_users is null || _user_groups is null)
    {
        <Loader />
    }
    else
    {
        <div class="animate__animated animate__fadeIn">
            <div class="menu">
                <div class="buttons">
                    <button class="@(_showUsers ? "selected" : "")" @onclick="() => _showUsers = true">Users</button>
                    <button class="@(!_showUsers ? "selected" : "")" @onclick="() => _showUsers = false">User groups</button>
                </div>

                @if (_showUsers)
                {
                    <input type="text" class="search" placeholder="Search by name..."
                        @oninput="@((e) => SearchUser(e.Value!.ToString()!))">
                }
                else
                {
                    <input type="text" class="search" placeholder="Search by name..."
                        @oninput="@((e) => SearchUserGroup(e.Value!.ToString()!))">
                }
            </div>

                @if (_showUsers)
                {
                    <ul class="table_users">
                        <li class="header">
                            <div class="col col-1">ID</div>
                            <div class="col col-2">Name</div>
                            <div class="col col-3">Group</div>
                            <div class="col col-4">Roles</div>
                        </li>
                        @foreach (var user in _users_searched!)
                        {
                            <li class="row" @onclick="() => _userMenu.ShowUser(user)">
                                <div class="col col-1" data-label="ID">@user.Id</div>
                                <div class="col col-2" data-label="Name">@user.Name</div>
                                <div class="col col-3" data-label="Group">
                                    @if (user.UserGroupId.ToString().All((c) => c == '0' || c == '-')){
                                        <div class="info_light">No group</div>
                                    }
                                    else{
                                        @_user_groups.FirstOrDefault(
                                            userGroup => userGroup?.Id.Equals(user.UserGroupId) ?? false, null
                                        )?.Name
                                    }
                                    
                                </div>
                                <div class="col col-4" data-label="Roles">
                                    @if(user.Roles.Count() == 0){
                                        <div class="info_light">No roles</div>
                                    }
                                    else{
                                        @foreach (var role in user.Roles)
                                        {
                                            <text>@role.Name&nbsp;</text>
                                        }
                                    }
                                    
                                </div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <ul class="table_groups">
                        <li class="header">
                            <div class="col col-1">ID</div>
                            <div class="col col-2">Name</div>
                            <div class="col col-3">Users</div>
                        </li>
                        @foreach (var user_group in _user_groups_searched!)
                        {
                            <li class="row">
                                <div class="col col-1" data-label="ID">@user_group.Id</div>
                                <div class="col col-2" data-label="Name">@user_group.Name</div>
                                <div class="col col-3" data-label="Users">users</div>
                            </li>
                        }
                    </ul>
                        <div class="flex-row">
                            <label>
                                <input placeholder="New user group name"
                                       @bind="_newUserGroupName"
                                       @bind:event="oninput"/>
                            </label>
                            <button class="btn btn-outline-dark"
                                    @onclick="CreateUserGroupButton">
                                Create
                            </button>
                        </div>
                }
            <div>
                <UserMenu @ref="_userMenu" OnUserChanged="UpdateData"/>
            </div>
        </div>
    }


@code {
    private UserMenu _userMenu = null!;

    private UserContract[]? _users;
    private UserContract[]? _users_searched;
    private UserGroupContract[]? _user_groups;
    private UserGroupContract[]? _user_groups_searched;

    private string _newUserGroupName = "";

    private bool _showUsers = true;

    protected override async Task OnInitializedAsync()
    {
        await UpdateData();
    }

    private async Task UpdateData()
    {
        var users = await AdministrationService.GetUsers();
        var userGroups = await AdministrationService.GetUserGroups();

        if (users is not null)
        {
            _users = users;
            _users_searched = users;
        }

        if (userGroups is not null)
        {
            _user_groups = userGroups;
            _user_groups_searched = userGroups;
        }

        StateHasChanged();
    }

    private async Task CreateUserGroupButton()
    {
        if (await AdministrationService.CreateUserGroup(_newUserGroupName))
        {
            await UpdateData();
        }
    }

    private void SearchUser(string searched_user)
    {
        if (searched_user is null)
        {
            return;
        }
        _users_searched = Array.FindAll(_users!, u => u.Name.Contains(searched_user));
    }

    private void SearchUserGroup(string searched_user_group)
    {
        if (searched_user_group is null)
        {
            return;
        }
        _user_groups_searched = Array.FindAll(_user_groups!, s => s.Name.Contains(searched_user_group));
    }
}