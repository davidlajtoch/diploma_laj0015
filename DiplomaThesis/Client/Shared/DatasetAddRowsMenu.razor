@using DiplomaThesis.Client.Services.Interfaces
@using DiplomaThesis.Shared.Contracts
@using System.Data;

@inject IDatasetService DatasetService
@inject IFileParsingService Parser
@inject IAdministrationService AdministrationService
@inject IJSRuntime JSRuntime

<div class="dataset_add_rows_menu_container animate__animated animate__fadeIn" style="display: @(ShowDatasetAddRowsMenu ? "block" : "none");">
    <div class="dataset_add_rows_menu">
        @if (Dataset is null)
        {
            <p>
                <em>Loading...</em>
            </p>
        }
        else
        {
            @if (!ShowFileFormatGuide)
            {
                <div class="section_dataset_add_rows animate__animated animate__fadeIn">
                    <table class="table_info">
                        <tr>
                            <td class="label">ID</td>
                            <td>@Dataset.Id</td>
                        </tr>
                        <tr>
                            <td class="label">Name</td>
                            <td>@Dataset.Name</td>
                        </tr>
                        <tr>
                            <td class="label">Columns</td>
                            <td>@Dataset.ColumnNames.Count()</td>
                        </tr>
                        <tr>
                            <td class="label">Uploaded through ReporTiny</td>
                            <td>@Dataset.ColumnNames.Any()</td>
                        </tr>
                    </table>

                    <div class="section_header">Existing data preview</div>
                    @if (@Dataset.ColumnNames.Any())
                    {
                        <table class="table_dataset_preview">
                            <tr>
                                @for (int i = 0; i < Dataset.ColumnNames.Count(); i++)
                                {
                                    <th>@Dataset.ColumnNames[i] : @Dataset.ColumnTypes[i]</th>
                                }
                            </tr>
                        </table>
                    }
                    else
                    {
                        <div class="info_preview_not_available text_light">Data preview is only available for datasets uploaded through ReporTiny</div>
                    }

                    <div class="section_header">New data preview</div>

                    @if (DataFileLoadProgress == 0)
                    {
                        <DragAndDropFileLoader OnFileLoaded=@LoadDatasetFile />
                    }

                    @if (DataFileLoadProgress == 1)
                    {
                        <div class="container_loading_file animate__animated animate__fadeIn">
                            <LoaderSmall />
                            <span>Loading the file, please wait...</span>
                        </div>
                    }

                    @if (DataFileLoadProgress == 2 && DatasetNewDataTable != null)
                    {
                        <table class="table_dataset_preview animate__animated animate__fadeIn">
                            <tr>
                                @for (int i = 0; i < DatasetNewDataTable.Columns.Count; i++)
                                {
                                    <th>
                                        @DatasetNewDataTable.Columns[i] :
                                        <span class="text_light">@DatasetNewDataTable.Columns[i].DataType.ToString().Split('.')[1]</span>
                                    </th>
                                }
                            </tr>
                            @for (int row = 0; row < DatasetPreviewMaxRows; row++)
                            {
                                <tr>
                                    @for (int column = 0; column < DatasetNewDataTable.Columns.Count; column++)
                                    {
                                        <td>
                                            @DatasetNewDataTable.Rows[row].ItemArray[column]
                                        </td>
                                    }
                                </tr>
                            }
                        </table>
                    }

                    <div class="bottom_menu">
                        <div class="group_left">
                            <button class="button_circle_default button_circle" @onclick="ToggleFileFormatGuide">
                                <i class="material-icons icon">help</i>
                            </button>
                        </div>
                        <div class="group_right">
                            <button class="button_default" @onclick="SaveAndToggleDatasetMenu">Save and close</button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <FileFormatGuide OnHide=ToggleFileFormatGuide />
            }

        }
    </div>
</div>


@code {
    [Parameter]
    public EventCallback OnDatasetChanged { get; set; }

    private DatasetContract? Dataset { get; set; }
    private DataTable? DatasetNewDataTable { get; set; }

    public bool ShowDatasetAddRowsMenu { get; set; }
    private bool ShowFileFormatGuide = false;
    private int DataFileLoadProgress = 0;
    private int DatasetFileMaxSize = 500 * 1024 * 1024; //500MB
    private const int DatasetPreviewMaxRows = 5;

    public async Task SaveAndToggleDatasetMenu()
    {
        ShowDatasetAddRowsMenu = !ShowDatasetAddRowsMenu;
        DataFileLoadProgress = 0;
        ShowFileFormatGuide = false;
    }

    public async Task ShowDataset(DatasetContract dataset)
    {
        Dataset = dataset;

        ShowDatasetAddRowsMenu = true;

        StateHasChanged();

        await Task.Delay(200);
    }

    public void ToggleFileFormatGuide()
    {
        ShowFileFormatGuide = !ShowFileFormatGuide;
    }

    private async Task LoadDatasetFile(IBrowserFile datasetFile)
    {
        var file = datasetFile;
        DataFileLoadProgress = 1;

        Console.WriteLine(file.ContentType);
        var datasetFileContent = await new StreamReader(file.OpenReadStream(maxAllowedSize: DatasetFileMaxSize)).ReadToEndAsync();
        string datasetJson;

        try
        {
            datasetJson = Parser.ParseToJson(datasetFileContent, datasetFile.Name.Split(".").Last());
            DatasetNewDataTable = Parser.ParseJsonToDataTable(datasetJson);
            DataFileLoadProgress = 2;


        }
        catch
        {
            Console.WriteLine("Exception");
            return;
        }

        //DataFileLoadProgress = 2;
    }
}
